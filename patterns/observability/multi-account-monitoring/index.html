
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../existing-eks-nginx-observability/">
      
      
        <link rel="next" href="../../security/eks-config-rules/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Multi Account Observability Pattern - Amazon EKS Blueprints Patterns</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a40c8224.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#multi-account-open-source-observability-pattern" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Amazon EKS Blueprints Patterns" class="md-header__button md-logo" aria-label="Amazon EKS Blueprints Patterns" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS Blueprints Patterns
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Multi Account Observability Pattern
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/cdk-eks-blueprints-patterns" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/cdk-eks-blueprints-patterns
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Amazon EKS Blueprints Patterns" class="md-nav__button md-logo" aria-label="Amazon EKS Blueprints Patterns" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Amazon EKS Blueprints Patterns
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/cdk-eks-blueprints-patterns" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/cdk-eks-blueprints-patterns
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Patterns
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Generative AI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Generative AI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../generative-ai/showcase/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prompt Showcase Pattern
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Observability Patterns
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Observability Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_2_1" id="__nav_2_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    New Cluster
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_1">
            <span class="md-nav__icon md-icon"></span>
            New Cluster
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-native/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS Native Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-graviton-opensource-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS Graviton Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-opensource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-awsnative-fargate-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fargate Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-mixed-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mixed Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-acc-new-eks-mixed-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi-Cluster Multi-Region Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-apiserver-opensource-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Apiserver Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-gpu-opensource-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS GPU Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-java-opensource-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Java Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-new-eks-nginx-opensource-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Nginx Monitoring
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Existing Cluster
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            Existing Cluster
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../existing-eks-awsnative-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS Native Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../existing-eks-mixed-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mixed Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../existing-eks-opensource-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Observability Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../existing-eks-apiserver-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Apiserver Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../existing-eks-nginx-observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OSS Nginx Monitoring
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Multi Account Observability Pattern
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Multi Account Observability Pattern
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      Objective
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Objective">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gitops-confguration" class="md-nav__link">
    <span class="md-ellipsis">
      GitOps confguration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploying">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validating-custom-metrics-and-traces-from-ho11y-app" class="md-nav__link">
    <span class="md-ellipsis">
      Validating Custom Metrics and Traces from ho11y App
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traces-and-service-map-screenshots-from-x-ray-console" class="md-nav__link">
    <span class="md-ellipsis">
      Traces and Service Map screenshots from X-Ray Console
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-amp-as-data-source" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Metrics from ho11y App on Amazon Managed Grafana Console using AMP as data source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-cloudwatch-as-data-source" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Metrics from ho11y App on Amazon Managed Grafana Console using CloudWatch as data source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Security Patterns
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Security Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/eks-config-rules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EKS Config Rules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/encryption-at-rest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Encryption At Rest
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/guardduty/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GuardDuty
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/image-scanning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Image Scanning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/securityhub/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SecurityHub
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../batch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS Batch Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backstage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backstage Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../custom-networking-with-ipv4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customer Network with IPV4 Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../instana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Instana Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../jupyterhub/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jupyterhub Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../knoveyor.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Konveyor Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubeflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubeflow Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubeshark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubeshark Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline-multi-env-gitops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi environment Pipeline GitOps pattern Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../multi-cluster-conformitron/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi cluster conformitron pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nginx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nginx Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../secureingresscognito/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Secure Ingress and Authentication Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../graviton/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Graviton Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows Pattern
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gmaestro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gMaestro Pattern
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      Objective
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Objective">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gitops-confguration" class="md-nav__link">
    <span class="md-ellipsis">
      GitOps confguration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploying">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validating-custom-metrics-and-traces-from-ho11y-app" class="md-nav__link">
    <span class="md-ellipsis">
      Validating Custom Metrics and Traces from ho11y App
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traces-and-service-map-screenshots-from-x-ray-console" class="md-nav__link">
    <span class="md-ellipsis">
      Traces and Service Map screenshots from X-Ray Console
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-amp-as-data-source" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Metrics from ho11y App on Amazon Managed Grafana Console using AMP as data source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-cloudwatch-as-data-source" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Metrics from ho11y App on Amazon Managed Grafana Console using CloudWatch as data source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="multi-account-open-source-observability-pattern">Multi Account Open Source Observability Pattern.<a class="headerlink" href="#multi-account-open-source-observability-pattern" title="Permanent link">¤</a></h1>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">¤</a></h2>
<p>The following figure illustrates the architecture of the pattern we will be deploying for Multi Account Observability pattern using open source tooling such as AWS Distro for Open Telemetry (ADOT), Amazon Managed Service for Prometheus (AMP), Amazon Managed Grafana :</p>
<p><img alt="Architecture" src="../../images/setup_amg-cross-account.png" /></p>
<h2 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link">¤</a></h2>
<ol>
<li>
<p>Deploying two production grade Amazon EKS cluster across 2 AWS Accounts ( Prod1, Prod2 account ) through a Continuous Deployment infrastructure pipeline triggered upon a commit to the repository that holds the pipeline configuration in an another AWS account (pipeline account).</p>
</li>
<li>
<p>Deploying ADOT add-on, AMP add-on to Prod 1 Amazon EKS Cluster to remote write metrics to AMP workspace in Prod 1 AWS Account. Deploying ADOT add-on, CloudWatch add-on to Prod 1 Amazon EKS Cluster to write metrics to CloudWatch in Prod 2 AWS Account.</p>
</li>
<li>
<p>Configuring GitOps tooling (ArgoCD addon) to support deployment of <a href="https://github.com/aws-observability/aws-o11y-recipes/tree/main/sandbox/ho11y">ho11y</a> and <a href="https://github.com/mreferre/yelb">yelb</a> sample applications, in a way that restricts each application to be deployed only into the team namespace, by using ArgoCD projects.</p>
</li>
<li>
<p>Setting up IAM roles in Prod 1 and Prod 2 Accounts to allow an AMG service role in the Monitoring account (4th AWS account) to access metrics from AMP workspace in Prod 1 account and CloudWatch namespace in Prod 2 account.</p>
</li>
<li>
<p>Setting Amazon Managed Grafana to visualize AMP metrics from Amazon EKS cluster in Prod account 1 and CloudWatch metrics on workloads in Amazon EKS cluster in Prod account 2.</p>
</li>
</ol>
<h3 id="gitops-confguration">GitOps confguration<a class="headerlink" href="#gitops-confguration" title="Permanent link">¤</a></h3>
<p>For GitOps, the blueprint bootstrap the ArgoCD addon and points to the <a href="https://github.com/aws-samples/eks-blueprints-workloads">EKS Blueprints Workload</a> sample repository.</p>
<p>You can find the team-geordie configuration for this pattern in the workload repository under the folder <a href="https://github.com/aws-samples/eks-blueprints-workloads/tree/main/teams/team-geordie"><code>team-geordie</code></a>.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">¤</a></h2>
<ol>
<li>
<p>AWS Control Tower deployed in your AWS environment in the management account. If you have not already installed AWS Control Tower, follow the <a href="https://docs.aws.amazon.com/controltower/latest/userguide/getting-started-with-control-tower.html">Getting Started with AWS Control Tower documentation</a>, or you can enable AWS Organizations in the AWS Management Console account and enable AWS SSO.</p>
</li>
<li>
<p>An AWS account under AWS Control Tower called Prod 1 Account(Workloads Account A aka prodEnv1) provisioned using the AWS Service Catalog Account Factory product AWS Control Tower Account vending process or AWS Organization.</p>
</li>
<li>
<p>An AWS account under AWS Control Tower called Prod 2 Account(Workloads Account B aka prodEnv2) provisioned using the AWS Service Catalog Account Factory product AWS Control Tower Account vending process or AWS Organization.</p>
</li>
<li>
<p>An AWS account under AWS Control Tower called Pipeline Account (aka pipelineEnv) provisioned using the AWS Service Catalog Account Factory product AWS Control Tower Account vending process or AWS Organization.</p>
</li>
<li>
<p>An AWS account under AWS Control Tower called Monitoring Account (Grafana Account aka monitoringEnv) provisioned using the AWS Service Catalog Account Factory product AWS Control Tower Account vending process or AWS Organization.</p>
</li>
</ol>
<h2 id="deploying">Deploying<a class="headerlink" href="#deploying" title="Permanent link">¤</a></h2>
<ol>
<li>
<p>Fork this repository to your GitHub organisation/user.</p>
</li>
<li>
<p>Clone your forked repository.</p>
</li>
<li>
<p>Set environment variable <code>AWS_REGION</code> with region from where <code>pipelineEnv</code> account will be bootstrapped.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_REGION</span><span class="o">=</span>&lt;YOUR<span class="w"> </span>AWS<span class="w"> </span>REGION&gt;
</code></pre></div>
</li>
<li>
<p>Install the AWS CDK Toolkit globally on your machine using</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>aws-cdk
</code></pre></div>
</li>
<li>
<p>Create secret <code>github-ssh-key</code> in <code>AWS_REGION</code> of <code>pipelineEnv</code> account. This secret must contain GitHub SSH private key as a JSON structure containing fields <code>sshPrivateKey</code> and <code>url</code> in <code>pipelineEnv</code> account. This will be used by ArgoCD addon to authenticate against any GitHub repository (private or public). The secret is expected to be defined in the region where the pipeline will be deployed to. For more information on SSH credentials setup see <a href="https://aws-quickstart.github.io/cdk-eks-blueprints/addons/argo-cd/#secrets-support">ArgoCD Secrets Support</a>.</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>secretsmanager<span class="w"> </span>create-secret<span class="w"> </span>--region<span class="w"> </span><span class="nv">$AWS_REGION</span><span class="w"> </span><span class="se">\</span>
--name<span class="w"> </span>github-ssh-key<span class="w"> </span><span class="se">\</span>
--description<span class="w"> </span><span class="s2">&quot;SSH private key for ArgoCD authentication to GitHub repository&quot;</span><span class="w"> </span><span class="se">\</span>
--secret-string<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;sshPrivateKey&quot;:&quot;&lt;SSH private key&gt;&quot;,</span>
<span class="s1">    &quot;url&quot;:&quot;git@github&quot;</span>
<span class="s1">}&#39;</span>
</code></pre></div>
</li>
<li>
<p>Create <code>github-token</code> secret in <code>AWS_REGION</code> of <code>pipelineEnv</code> account. This secret must be stored as a plain text in AWS Secrets Manager for the GitHub pipeline in <code>pipelineEnv</code> account. For more information on how to set it up, please refer to the <a href="https://docs.aws.amazon.com/codepipeline/latest/userguide/GitHub-create-personal-token-CLI.html">docs</a>. The GitHub Personal Access Token should have these scopes:</p>
<ol>
<li>
<p><em>repo</em> - to read the repository</p>
</li>
<li>
<p><em>admin:repo_hook</em> - if you plan to use webhooks (enabled by default)</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>secretsmanager<span class="w"> </span>create-secret<span class="w"> </span>--region<span class="w"> </span><span class="nv">$AWS_REGION</span><span class="w"> </span><span class="se">\</span>
--name<span class="w"> </span>github-token<span class="w"> </span><span class="se">\</span>
--description<span class="w"> </span><span class="s2">&quot;GitHub Personal Access Token for CodePipeline to access GitHub account&quot;</span><span class="w"> </span><span class="se">\</span>
--secret-string<span class="w"> </span><span class="s2">&quot;&lt;GitHub Personal Access Token&gt;&quot;</span>
</code></pre></div>
</li>
<li>
<p>Create secret <code>cdk-context</code> in <code>us-east-1</code> region as a plain text in AWS Secrets Manager for the GitHub pipeline in <code>pipelineEnv</code> account. <code>cdk-context</code> secret must be stored as a plain text in the following format in AWS Secrets Manager for cdk context for all the 4 AWS accounts used by the solution in <code>pipelineEnv</code> account. This secret must be created in <code>us-east-1</code> region.</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>secretsmanager<span class="w"> </span>create-secret<span class="w"> </span>--region<span class="w"> </span>us-east-1<span class="w"> </span><span class="se">\</span>
--name<span class="w"> </span>cdk-context<span class="w"> </span><span class="se">\</span>
--description<span class="w"> </span><span class="s2">&quot;AWS account details of different environments used by Multi account open source Observability pattern&quot;</span><span class="w"> </span><span class="se">\</span>
--secret-string<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">&quot;context&quot;: {</span>
<span class="s1">    &quot;prodEnv1&quot;: {</span>
<span class="s1">        &quot;account&quot;: &quot;&lt;prodEnv1 account number&gt;&quot;,</span>
<span class="s1">        &quot;region&quot;: &quot;&lt;AWS REGION&gt;&quot;</span>
<span class="s1">    },</span>
<span class="s1">    &quot;prodEnv2&quot;: {</span>
<span class="s1">        &quot;account&quot;: &quot;&lt;prodEnv2 account number&gt;&quot;,</span>
<span class="s1">        &quot;region&quot;: &quot;&lt;AWS REGION&gt;&quot;</span>
<span class="s1">    },</span>
<span class="s1">    &quot;pipelineEnv&quot;: {</span>
<span class="s1">        &quot;account&quot;: &quot;&lt;pipelineEnv account number&gt;&quot;,</span>
<span class="s1">        &quot;region&quot;: &quot;&lt;AWS REGION&gt;&quot;</span>
<span class="s1">    },</span>
<span class="s1">    &quot;monitoringEnv&quot;: {</span>
<span class="s1">        &quot;account&quot;: &quot;&lt;prodmonitoringEnvEnv1 account number&gt;&quot;,</span>
<span class="s1">        &quot;region&quot;: &quot;&lt;AWS REGION&gt;&quot;</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">}&#39;</span>
</code></pre></div>
</li>
<li>
<p>Create the following IAM users and attach <code>administrator</code> policy to required accounts.</p>
<ol>
<li>
<p>IAM user <code>pipeline-admin</code> with <code>administrator</code> policy in Pipeline AWS Account</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>pipelineEnv-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>pipeline-admin

aws<span class="w"> </span>iam<span class="w"> </span>attach-user-policy<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>pipelineEnv-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>pipeline-admin<span class="w"> </span><span class="se">\</span>
--policy-arn<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess
</code></pre></div>
</li>
<li>
<p>IAM user <code>prod1-admin</code> with <code>administrator</code> policy in Prod 1 AWS Account</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv1-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>prod1-admin

aws<span class="w"> </span>iam<span class="w"> </span>attach-user-policy<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv1-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>prod1-admin<span class="w"> </span><span class="se">\</span>
--policy-arn<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess
</code></pre></div>
</li>
<li>
<p>IAM user <code>prod2-admin</code> with <code>administrator</code> policy in Prod 2 AWS Account</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv2-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>prod2-admin

aws<span class="w"> </span>iam<span class="w"> </span>attach-user-policy<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv2-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>prod2-admin<span class="w"> </span><span class="se">\</span>
--policy-arn<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess
</code></pre></div>
</li>
<li>
<p>IAM user <code>mon-admin</code> with <code>administrator</code> policy in Monitoring AWS Account</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>monitoringEnv-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>mon-admin

aws<span class="w"> </span>iam<span class="w"> </span>attach-user-policy<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>monitoringEnv-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>mon-admin<span class="w"> </span><span class="se">\</span>
--policy-arn<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess
</code></pre></div>
</li>
<li>
<p>IAM user <code>team-geordi</code> in Prod 1 and Prod 2 AWS Account</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv1-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>team-geordi

aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv2-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>team-geordi<span class="w">        </span>
</code></pre></div>
</li>
<li>
<p>IAM user <code>team-platform</code> in Prod 1 and Prod 2 AWS Account</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv1-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>team-platform

aws<span class="w"> </span>iam<span class="w"> </span>create-user<span class="w"> </span><span class="se">\</span>
<span class="o">[</span>--profile<span class="w"> </span>prodEnv2-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
--user-name<span class="w"> </span>team-platform<span class="w">     </span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>Install project dependencies by running <code>npm install</code> in the main folder of this cloned repository</p>
</li>
<li>
<p>Bootstrap all 4 AWS accounts using step mentioned for <strong>different environment for deploying CDK applications</strong> in <a href="https://aws-quickstart.github.io/cdk-eks-blueprints/pipelines/#deploying-pipelines">Deploying Pipelines</a>. If you have bootstrapped earlier, please remove them before proceeding with this step. Remember to set <code>pipelineEnv</code> account number in <code>--trust</code> flag. You can also refer to commands mentioned below:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># bootstrap prodEnv1 account with trust access from pipelineEnv account</span>
env<span class="w"> </span><span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>npx<span class="w"> </span>cdk<span class="w"> </span>bootstrap<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">[</span>--profile<span class="w"> </span>prodEnv1-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cloudformation-execution-policies<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--trust<span class="w"> </span>&lt;pipelineEnv<span class="w"> </span>account<span class="w"> </span>number&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>aws://&lt;prodEnv1<span class="w"> </span>account<span class="w"> </span>number&gt;/<span class="nv">$AWS_REGION</span>

<span class="c1"># bootstrap prodEnv2 account with trust access from pipelineEnv account</span>
env<span class="w"> </span><span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>npx<span class="w"> </span>cdk<span class="w"> </span>bootstrap<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">[</span>--profile<span class="w"> </span>prodEnv2-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cloudformation-execution-policies<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--trust<span class="w"> </span>&lt;pipelineEnv<span class="w"> </span>account<span class="w"> </span>number&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>aws://&lt;prodEnv2<span class="w"> </span>account<span class="w"> </span>number&gt;/<span class="nv">$AWS_REGION</span>

<span class="c1"># bootstrap pipelineEnv account WITHOUT explicit trust </span>
env<span class="w"> </span><span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>npx<span class="w"> </span>cdk<span class="w"> </span>bootstrap<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">[</span>--profile<span class="w"> </span>pipelineEnv-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cloudformation-execution-policies<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>aws://&lt;pipelineEnv<span class="w"> </span>account<span class="w"> </span>number&gt;/<span class="nv">$AWS_REGION</span>

<span class="c1"># bootstrap monitoringEnv account with trust access from pipelineEnv account</span>
env<span class="w"> </span><span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>npx<span class="w"> </span>cdk<span class="w"> </span>bootstrap<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">[</span>--profile<span class="w"> </span>monitoringEnv-admin-profile<span class="o">]</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cloudformation-execution-policies<span class="w"> </span>arn:aws:iam::aws:policy/AdministratorAccess<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--trust<span class="w"> </span>&lt;pipelineEnv<span class="w"> </span>account<span class="w"> </span>number&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>aws://&lt;monitoringEnv<span class="w"> </span>account<span class="w"> </span>number&gt;/<span class="nv">$AWS_REGION</span>
</code></pre></div>
</li>
<li>
<p>Modify the code of <code>lib/pipeline-multi-env-gitops/index.ts</code> and <code>lib/multi-account-monitoring/pipeline.ts</code> in your forked repo to point to your GitHub username/organisation. Look for the declared const of <code>gitOwner</code> and change it to your GitHub username and commit changes to your forked repo. This is needed because the AWS CodePipeline that will be automatically created will be triggered upon commits that are made in your forked repo.</p>
</li>
<li>
<p>Once all pre-requisites are set you are ready to deploy the pipeline. Run the following command from the root of this repository to deploy the pipeline stack in <code>pipelineEnv</code> account:</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>build
make<span class="w"> </span>pattern<span class="w"> </span>pipeline-multienv-monitoring<span class="w"> </span>deploy<span class="w"> </span>multi-account-central-pipeline
</code></pre></div>
</li>
<li>
<p>Now you can go to <a href="https://eu-west-1.console.aws.amazon.com/codesuite/codepipeline/pipelines">AWS CodePipeline console</a>, and see how it was automatically created to deploy multiple Amazon EKS clusters to different environments. </p>
</li>
<li>
<p>The deployment automation will create <code>ampPrometheusDataSourceRole</code> with permissions to retrieve metrics from AMP in Prod 1 Account, <code>cloudwatchDataSourceRole</code> with permissions to retrieve metrics from CloudWatch in Prod 2 Account and <code>amgWorkspaceIamRole</code> in monitoring account to assume roles in Prod 1 and Prod 2 account for retrieving and visualizing metrics in Grafana.</p>
</li>
<li>
<p>Next, manually follow the following steps from <a href="https://aws.amazon.com/blogs/opensource/setting-up-amazon-managed-grafana-cross-account-data-source-using-customer-managed-iam-roles/#:~:text=AWS%20SSO%20in%20the%20management%20account">AWS Open Source blog</a> :</p>
<ol>
<li>AWS SSO in the management account</li>
<li>Query metrics in Monitoring account from Amazon Managed Prometheus workspace in Prod 1 Account</li>
<li>Query metrics in the Monitoring account from Amazon CloudWatch in Prod 1 Account</li>
</ol>
</li>
</ol>
<p><img alt="Metrics from AMP" src="../../images/AMG%20-%20Metrics%20from%20AMP.png" /></p>
<p><img alt="Metrics from CloudWatch" src="../../images/AMG%20-%20Metrics%20from%20CloudWatch.png" /></p>
<h3 id="validating-custom-metrics-and-traces-from-ho11y-app">Validating Custom Metrics and Traces from ho11y App<a class="headerlink" href="#validating-custom-metrics-and-traces-from-ho11y-app" title="Permanent link">¤</a></h3>
<ol>
<li>
<p>Run the below command in both clusters to generate traces to X-Ray and Amazon Managed Grafana Console out the sample <code>ho11y</code> app :</p>
<div class="highlight"><pre><span></span><code>frontend_pod=`kubectl get pod -n geordie --no-headers -l app=frontend -o jsonpath=&#39;{.items[*].metadata.name}&#39;`
loop_counter=0
while [ $loop_counter -le 5000 ] ;
do
        kubectl exec -n geordie -it $frontend_pod -- curl downstream0.geordie.svc.cluster.local;
        echo ;
        loop_counter=$[$loop_counter+1];
done
</code></pre></div>
<h3 id="traces-and-service-map-screenshots-from-x-ray-console">Traces and Service Map screenshots from X-Ray Console<a class="headerlink" href="#traces-and-service-map-screenshots-from-x-ray-console" title="Permanent link">¤</a></h3>
</li>
</ol>
<p><img alt="Traces of ho11y App on X-Ray Console" src="../../images/XRAY%20-%20Traces.png" /></p>
<p><img alt="Service Map of ho11y App on X-Ray Console" src="../../images/XRAY%20-%20Service%20Map.png" /></p>
<h3 id="custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-amp-as-data-source">Custom Metrics from ho11y App on Amazon Managed Grafana Console using AMP as data source<a class="headerlink" href="#custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-amp-as-data-source" title="Permanent link">¤</a></h3>
<p><img alt="Exploring Metrics from ho11y with AMP as Data source in AMG Console" src="../../images/Explore%20AMG.png" /></p>
<h3 id="custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-cloudwatch-as-data-source">Custom Metrics from ho11y App on Amazon Managed Grafana Console using CloudWatch as data source<a class="headerlink" href="#custom-metrics-from-ho11y-app-on-amazon-managed-grafana-console-using-cloudwatch-as-data-source" title="Permanent link">¤</a></h3>
<p><img alt="Exploring Metrics from ho11y with CloudWatch as Data source in AMG Console" src="../../images/Explore%20AMG.png" /></p>
<h3 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">¤</a></h3>
<p>This pattern consumes multiple Elastic IP addresses, because 3 VPCs with 3 subnets are created by this pattern in Prod 1 and Prod 2 AWS Accounts. Make sure your account limits for EIP are increased to support additional 9 EIPs (1 per Subnets).</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  </body>
</html>